<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>seteuid0's blog</title><link>/</link><description>Recent content on seteuid0's blog</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><copyright>This is a customized copyright.</copyright><lastBuildDate>Sun, 18 Apr 2021 11:16:32 +0800</lastBuildDate><atom:link href="/index.xml" rel="self" type="application/rss+xml"/><item><title>First Post</title><link>/posts/first-post/</link><pubDate>Sun, 18 Apr 2021 11:16:32 +0800</pubDate><guid>/posts/first-post/</guid><description>seteuid0's blog /posts/first-post/ -&lt;h2 id="hello-world">hello world&lt;/h2>
- /posts/first-post/ - This is a customized copyright.</description></item><item><title>[zz]RHEL 5/6 差异：时间处理机制</title><link>/posts/zz_rhel_56_difference_time_handling_mechanism/</link><pubDate>Mon, 29 Jul 2013 17:13:00 +0000</pubDate><guid>/posts/zz_rhel_56_difference_time_handling_mechanism/</guid><description>seteuid0's blog /posts/zz_rhel_56_difference_time_handling_mechanism/ -&lt;p>when you use different linux system,you will find the time&amp;rsquo;s different between the systems,here is the reason.RHEL 5/6 差异：时间处理机制06.29.2012, 系统服务 , by Roger.RHEL 5/6 差异：时间处理机制作者：Roger简介本文介绍了在 RHEL5 和 RHEL 6 两个版本系统中，对待时间的差异。目的在于帮助我们了解系统，应对OS升级的改动。概述RHEL 5/6 时间机制差异类别RHEL 5RHEL 6建议Anaconda 参数timezone &amp;ndash;utc修改/etc/sysconfig/clock修改/etc/adjtime对用户透明，不用调整开机初始化脚本，硬件时钟到系统时钟/etc/rc.d/rc.sysinit传参调用hwclock内核直接读取rtc_cmos获取时间/etc/sysconfig/clock需要区分关机脚本，系统时钟到硬件时钟/etc/rc.d/init.d/halt传参数调用hwclock/etc/rc.d/init.d/halt直接调用hwclock/etc/sysconfig/clock需要区分NTP软件包一个包：ntp-4.2.2p1-9.el5_3.2三个包：ntp-4.2.4p8-2.el6.centos.i686ntp-perl-4.2.4p8-2.el6.centos.i686ntpdate-4.2.4p8-2.el6.centos.i686RHEL 6 把 RHEL 5 一个包拆成了三个RHEL 6 建议三个包都安装ntpd启动脚本一个脚本：/etc/rc.d/init.d/ntpd两个脚本：/etc/rc.d/init.d/ntpd/etc/rc.d/init.d/ntpdateRHEL 6 中添加了ntpdate启动脚本，相当于额外多了一个服务，需要注意RHEL 5 与 RHEL 6 中，时间这块，外围软件包改动并不大，例如hwclock，NTP。改动比较大的是：Anaconda安装系统时，timezone &amp;ndash;utc的处理方式。开机读取硬件时钟的机制。关机写入硬件时钟的机制。linux 时间存储 原理分析首先需要了解的概念：硬件时钟系统时钟其次，BIOS里硬件时钟存的仅是一个UNIX时间戳。这个时间戳，有UTC时钟和LOCAL时钟两钟存法。UTC时间LOCAL时间（本地时间）注意点：我们所说的system clock use UTC (timezone &amp;ndash;utc) 实际上就是指BIOS里的时钟存法。与系统的“时区”没有关系。这点不要混淆。这里举一个你常见的例子：笔记本双系统，win+linux，如果linux使用了UTC时间，那么两个系统就会差8小时。原因：Unix规范里BIOS时钟存UTC时间戳，但windows改成了只支持存LOCAL时间戳（就是你墙上的时间），而linux两个格式都支持。这时，如果你linux使用了UTC时间，就会把BIOS的时间戳当作UTC时间，而你的windows把BIOS时间戳当作LOCAL时间。所以无论你怎么调，两个系统时间都不会一致。hwclock说到linux下的时钟，一定不能忽略hwclock，硬件时钟和系统时钟的互写就全靠它了。后续我们详解hwclock的工作机制。推荐看 man clock。开机对时钟的处理我们电脑关机状态时，硬件上的晶振会持续保存一个时间，这个时间就是硬件时钟。进入BIOS便可以看到。开机后，系统将硬件时钟读入系统，然后开始维持时间的增长。硬件时钟仅开机读取一次，由于进入了OS，我们有很多途径让时钟更准确，比如NTP等，这时的硬件时钟对我们是没有用的。关机对时钟的处理要关机了，系统会把时间写入硬件时钟，相当于更新硬件时钟。RHEL 5/6 都是/etc/rc.d/init.d/halt调用hwclock来写入硬件时钟，细节上略有不同，但都是做一样的事情。hwclockRHEL 5/6 中hwclock机制并没有变化：这里需要注意的是：hwclock维护一个文件，/etc/adjtime，用来确定硬件时钟是UTC还是LOCAL。hwclock原理分析：我们直接执行hwclock，就是读取硬件时钟。01[root@centos6 install]# strace -e trace=open hwclock02open(&amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY)      = 303open(&amp;quot;/lib/libaudit.so.1&amp;quot;, O_RDONLY)    = 304open(&amp;quot;/lib/libc.so.6&amp;quot;, O_RDONLY)        = 305open(&amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_LARGEFILE) = 406open(&amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_LARGEFILE) = 407open(&amp;quot;/dev/rtc&amp;quot;, O_RDONLY|O_LARGEFILE)  = 408open(&amp;quot;/etc/adjtime&amp;quot;, O_RDONLY|O_LARGEFILE) = 509open(&amp;quot;/usr/share/zoneinfo/Universal&amp;quot;, O_RDONLY) = 510open(&amp;quot;/etc/localtime&amp;quot;, O_RDONLY)        = 511open(&amp;quot;/usr/share/locale/locale.alias&amp;quot;, O_RDONLY) = 512open(&amp;quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)13open(&amp;quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)14open(&amp;quot;/usr/share/locale/zh_CN/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = 515open(&amp;quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)16open(&amp;quot;/usr/share/locale/zh.utf8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)17open(&amp;quot;/usr/share/locale/zh/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)18Wed 09 May 2012 05:56:55 PM CST  -0.430311 seconds1.hwclock首先打开了/dev/rtc,读取硬件时钟.2.打开/etc/adjtime文件,通过先前的记录来估算硬件时钟的偏差,并用来校正目前的时间.3.打开/etc/localtime时区文件,将硬件时间转换为当前时区对应的时间.我们执行hwclock -w &amp;ndash;debug，写入硬件时钟。同时打开debug模式，方便观察。01[root@centos6 install]# strace -e trace=open hwclock -w &amp;ndash;debug02open(&amp;quot;/etc/ld.so.cache&amp;quot;, O_RDONLY)      = 303open(&amp;quot;/lib/libaudit.so.1&amp;quot;, O_RDONLY)    = 304open(&amp;quot;/lib/libc.so.6&amp;quot;, O_RDONLY)        = 305open(&amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_LARGEFILE) = 406open(&amp;quot;/usr/lib/locale/locale-archive&amp;quot;, O_RDONLY|O_LARGEFILE) = 407open(&amp;quot;/usr/share/locale/locale.alias&amp;quot;, O_RDONLY) = 408open(&amp;quot;/usr/share/locale/zh_CN.UTF-8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)09open(&amp;quot;/usr/share/locale/zh_CN.utf8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)10open(&amp;quot;/usr/share/locale/zh_CN/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = 411open(&amp;quot;/usr/share/locale/zh.UTF-8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)12open(&amp;quot;/usr/share/locale/zh.utf8/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)13open(&amp;quot;/usr/share/locale/zh/LC_MESSAGES/util-linux-ng.mo&amp;quot;, O_RDONLY) = -1 ENOENT (No such file or directory)14hwclock from util-linux-ng 2.17.215open(&amp;quot;/dev/rtc&amp;quot;, O_RDONLY|O_LARGEFILE)  = 416Using /dev interface to clock.17open(&amp;quot;/etc/adjtime&amp;quot;, O_RDONLY|O_LARGEFILE) = 518Last drift adjustment done at 1336557886 seconds after 196919Last calibration done at 1336557886 seconds after 196920Hardware clock is on UTC time21Assuming hardware clock is kept in UTC time.22Waiting for clock tick&amp;hellip;23&amp;hellip;got clock tick24Time read from Hardware Clock: 2012/05/09 10:38:0725open(&amp;quot;/usr/share/zoneinfo/Universal&amp;quot;, O_RDONLY) = 526Hw clock time : 2012/05/09 10:38:07 = 1336559887 seconds since 196927open(&amp;quot;/etc/localtime&amp;quot;, O_RDONLY)        = 528Time elapsed since reference time has been 0.505254 seconds.29Delaying further to reach the new time.30Setting Hardware Clock to 10:38:08 = 1336559888 seconds since 196931ioctl(RTC_SET_TIME) was successful.32Not adjusting drift factor because it has been less than a day since the last calibration.33open(&amp;quot;/etc/adjtime&amp;quot;, O_WRONLY|O_CREAT|O_TRUNC|O_LARGEFILE, 0666) = 51.打开/dev/rtc，读取硬件时钟。2.打开/etc/adjtime文件,通过先前的记录来估算硬件时钟的偏差,并用来校正目前的时间.3.打开/etc/localtime时区文件,将硬件时间转换为当前时区对应的时间.4.ioctl写入硬件时钟5.更新/etc/adjtime文件里的时间戳/etc/adjtime由hwclock维护，默认不需要我们修改。如果修改，也仅是 RHEL 6 上修改第三行。UTC / LOCAL 。1[root@centos6 install]# cat /etc/adjtime2-0.436938 1336541643 0.000000313365416434UTC不同之处的注意点在 RHEL 5 中，开机会读取/etc/sysconfig/clock，传参数给 hwclock，因此/etc/adjtime文件失效，会以/etc/sysconfig/clock为准。关机也同样是这个原理。在 RHEL 6 中，不再有/etc/sysconfig/clock的参与，hwclock直接读取/etc/adjtime处理时间格式。Anaconda我们安装系统时，一般设置为：timezone Asia/Shanghai。也就是不使用UTC时间。RHEL 5 中，Anaconda会修改/etc/sysconfig/clock文件。1[hongmeng@login1.cm4 ~]$ cat /etc/sysconfig/clock2ZONE=&amp;ldquo;Asia/Shanghai&amp;quot;3UTC=false4ARC=falseRHEL 6 中，Anaconda会直接修改/etc/adjtime文件。/etc/sysconfig/clock里UTC，ARC等配置无意义。因为/etc/rc.d/rc.sysinit和/etc/rc.d/init.d/halt已经不再读取/etc/sysconfig/clock。1[root@opsinfo1 ~]# cat /etc/sysconfig/clock2ZONE=&amp;ldquo;Asia/Shanghai&amp;quot;1[root@opsinfo1 ~]# cat /etc/adjtime2-0.004473 1336506385 0.000000313365063854LOCAL相关源码：RHEL 5 Anaconda：1usr/lib/anaconda/timezone.py2 3        f = open(instPath + &amp;ldquo;/etc/sysconfig/clock&amp;rdquo;, &amp;ldquo;w&amp;rdquo;)4 5        f.write(&amp;lsquo;ZONE=&amp;quot;%s&amp;quot;n&amp;rsquo; % self.tz)6        f.write(&amp;ldquo;UTC=%sn&amp;rdquo; % bool(self.utc))7        f.write(&amp;ldquo;ARC=%sn&amp;rdquo; % bool(self.arc))8 9        f.close()RHEL 6 Anaconda：01usr/lib/anaconda/timezone.py02 03        f = open(instPath + &amp;ldquo;/etc/adjtime&amp;rdquo;, &amp;ldquo;w&amp;rdquo;)04        f.write(lines[0])05        f.write(lines[1])06        if self.utc:07            f.write(&amp;ldquo;UTCn&amp;rdquo;)08        else:09            f.write(&amp;ldquo;LOCALn&amp;rdquo;)10        f.close()/etc/rc.d/rc.sysinitRHEL 5 中，开机启动脚本会读取/etc/sysconfig/clock，再传参调用hwclock。将硬件时钟写入系统时钟。01# Set the system clock.02update_boot_stage RCclock03ARC=004SRM=005UTC=006 07if [ -f /etc/sysconfig/clock ]; then08   . /etc/sysconfig/clock09 10   # convert old style clock config to new values11   if [ &amp;ldquo;${CLOCKMODE}&amp;rdquo; = &amp;ldquo;GMT&amp;rdquo; ]; then12      UTC=true13   elif [ &amp;ldquo;${CLOCKMODE}&amp;rdquo; = &amp;ldquo;ARC&amp;rdquo; ]; then14      ARC=true15   fi16fi17 18CLOCKDEF=&amp;ldquo;&amp;ldquo;19CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;hctosys&amp;quot;20 21case &amp;ldquo;$UTC&amp;rdquo; in22    yes|true)   CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;utc&amp;quot;23                CLOCKDEF=&amp;quot;$CLOCKDEF (utc)&amp;rdquo; ;;24    no|false)   CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;localtime&amp;quot;25                CLOCKDEF=&amp;quot;$CLOCKDEF (localtime)&amp;rdquo; ;;26esac27case &amp;ldquo;$ARC&amp;rdquo; in28    yes|true)   CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;arc&amp;quot;29                CLOCKDEF=&amp;quot;$CLOCKDEF (arc)&amp;rdquo; ;;30esac31case &amp;ldquo;$SRM&amp;rdquo; in32    yes|true)   CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;srm&amp;quot;33                CLOCKDEF=&amp;quot;$CLOCKDEF (srm)&amp;rdquo; ;;34esac35 36[ -x /sbin/hwclock ] &amp;amp;&amp;amp; /sbin/hwclock $CLOCKFLAGS37 38action $&amp;ldquo;Setting clock $CLOCKDEF: `date`&amp;rdquo; /bin/trueRHEL 6 中，开机启动脚本不再调用hwclock。/etc/rc.d/init.d/haltRHEL 5 中，关机脚本会读取/etc/sysconfig/clock，再传参调用hwclock。将系统时钟写入硬件时钟。01# Sync the system clock.02ARC=003SRM=004UTC=005 06if [ -f /etc/sysconfig/clock ]; then07   . /etc/sysconfig/clock08 09   # convert old style clock config to new values10   if [ &amp;ldquo;${CLOCKMODE}&amp;rdquo; = &amp;ldquo;GMT&amp;rdquo; ]; then11      UTC=true12   elif [ &amp;ldquo;${CLOCKMODE}&amp;rdquo; = &amp;ldquo;ARC&amp;rdquo; ]; then13      ARC=true14   fi15fi16 17CLOCKDEF=&amp;ldquo;&amp;ldquo;18CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;systohc&amp;quot;19 20case &amp;ldquo;$UTC&amp;rdquo; in21   yes|true)22    CLOCKFLAGS=&amp;quot;$CLOCKFLAGS -u&amp;rdquo;;23    CLOCKDEF=&amp;quot;$CLOCKDEF (utc)&amp;quot;;24    ;;25   no|false)26    CLOCKFLAGS=&amp;quot;$CLOCKFLAGS &amp;ndash;localtime&amp;rdquo;;27    CLOCKDEF=&amp;quot;$CLOCKDEF (localtime)&amp;quot;;28    ;;29esac30 31case &amp;ldquo;$ARC&amp;rdquo; in32   yes|true)33    CLOCKFLAGS=&amp;quot;$CLOCKFLAGS -A&amp;quot;;34    CLOCKDEF=&amp;quot;$CLOCKDEF (arc)&amp;quot;;35    ;;36esac37case &amp;ldquo;$SRM&amp;rdquo; in38   yes|true)39    CLOCKFLAGS=&amp;quot;$CLOCKFLAGS -S&amp;quot;;40    CLOCKDEF=&amp;quot;$CLOCKDEF (srm)&amp;quot;;41    ;;42esac43 44[ -x /sbin/hwclock ] &amp;amp;&amp;amp; action $&amp;ldquo;Syncing hardware clock to system time&amp;rdquo; /sbin/hwclock $CLOCKFLAGSRHEL 6 中，关机脚本不读取/etc/sysconfig/clock，直接调用hwclock。将系统时钟写入硬件时钟。1# Save random seed2touch /var/lib/random-seed3chmod 600 /var/lib/random-seed4action $&amp;ldquo;Saving random seed: &amp;quot; dd if=/dev/urandom of=/var/lib/random-seed count=1 bs=512 2&amp;gt;/dev/null5 6[ -x /sbin/hwclock -a -e /dev/rtc ] &amp;amp;&amp;amp; action $&amp;ldquo;Syncing hardware clock to system time&amp;rdquo; /sbin/hwclock &amp;ndash;systohc/etc/sysconfig/clockRHEL 5:1ZONE=&amp;ldquo;Asia/Shanghai&amp;quot;2UTC=false3ARC=falseRHEL 6:1ZONE=&amp;ldquo;Asia/Shanghai&amp;quot;NTP软件包RHEL 5 中，NTP 只有一个软件包。1ntp-4.2.2p1-9.el5_3.2RHEL 6 中，NTP 有三个软件包。1ntp-4.2.4p8-2.el6.centos.i6862ntp-perl-4.2.4p8-2.el6.centos.i6863ntpdate-4.2.4p8-2.el6.centos.i686内容其实是一样的，RHEL 6 里只是拆分了，这块可以看NTP相关的文档。ntpd启动脚本RHEL 5:/etc/rc.d/init.d/ntpdRHEL 6:/etc/rc.d/init.d/ntpd/etc/rc.d/init.d/ntpdate影响与应对配置文件/etc/sysconfig/clock需要区分，否则 RHEL 6 写了也不生效。RHEL 5:1ZONE=&amp;ldquo;Asia/Shanghai&amp;quot;2UTC=false3ARC=falseRHEL 6:1ZONE=&amp;ldquo;Asia/Shanghai&amp;quot;另外，RHEL 6里，三个包都建议装上。&lt;/p>
- /posts/zz_rhel_56_difference_time_handling_mechanism/ - This is a customized copyright.</description></item></channel></rss>